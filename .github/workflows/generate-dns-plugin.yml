name: Generate DNS Plugin from TXT

on:
  schedule:
    - cron: '0 2 * * *' # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œ
  push:
    branches:
      - main

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      # æ£€å‡ºä»£ç ä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v3

      # ä¸‹è½½ geosite-geolocation-cn.txt æ–‡ä»¶
      - name: Download TXT file
        run: |
          curl -L -o geosite-geolocation-cn.txt https://raw.githubusercontent.com/love796-QAQ/loon-geosite/rule-set/geosite-geolocation-cn.txt

      # æ ¼å¼åŒ–åŸŸåä¸º [Host] æ ¼å¼
      - name: Format domains for DNS plugin
        run: |
          output_file="dns.plugin"
          # æ’å…¥æ–‡ä»¶å¤´éƒ¨
          cat <<EOF > "$output_file"
#!name = ğŸ“º BiliBili: âš™ï¸ Enhanced
#!desc = å“”å“©å“”å“©ï¼šå¢å¼ºæ¨¡å¼\\nä¸­å›½ç«™åŠŸèƒ½å¢å¼ºåŠUIè‡ªå®šä¹‰
#!openUrl = http://boxjs.com/#/app/BiliBili.Enhanced
#!author = VirgilClyne[https://github.com/VirgilClyne]
#!homepage = https://Enhanced.BiliUniverse.io
#!icon = https://github.com/BiliUniverse/Enhanced/raw/main/src/assets/icon_rounded.png
#!tag = ğŸª BiliUniverse
#!system = iOS,iPadOS,macOS,tvOS
#!date = $(date '+%Y-%m-%d %H:%M:%S')
#!version = 0.5.3
#!system_version = 15

[Host]
EOF

          # ä» TXT æ–‡ä»¶æå–å¹¶æ ¼å¼åŒ–
          grep -E '^DOMAIN-SUFFIX|^DOMAIN' geosite-geolocation-cn.txt | \
          sed -E 's/^DOMAIN-SUFFIX,([a-zA-Z0-9.-]+)/*.\1 = server:system/' | \
          sed -E 's/^DOMAIN,([a-zA-Z0-9.-]+)/\1 = server:system/' >> "$output_file"

      # æäº¤å¹¶æ¨é€ç»“æœ
      - name: Commit and Push
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@users.noreply.github.com"
          git add dns.plugin
          git commit -m "Update DNS plugin"
          git push
        env:
          GIT: ${{ secrets.GIT }}
